<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <!-- Keep maximum-scale not set so users can still pinch-zoom -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>Kevin | AI Resume Assistant</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">

  <style>
    :root { color-scheme: light; }
    html, body { width: 100%; max-width: 100%; overflow-x: hidden; height: 100%; overscroll-behavior: none; }

    body {
      font-family: 'Roboto', sans-serif;
      margin: 0; padding: 0;
      background: #f7f9fc; color: #031B4E;
    }

    /* Freeze background when modal open (no scroll, no layout shift) */
    html.kc-freeze, body.kc-freeze { overflow: hidden; }
    body.kc-freeze { position: fixed; left: 0; right: 0; width: 100%; }PROD

    /* ====== HEADER with animated gradient + data network canvas ====== */
    @keyframes gradientBG { 0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%} }
    .ds-hero{
      position:relative;overflow:hidden;
      background:linear-gradient(-45deg,#031B4E,#053071,#06449A,#031B4E);
      background-size:400% 400%;animation:gradientBG 10s ease infinite;
      color:#fff;padding:40px 20px;text-align:center;isolation:isolate
    }
    #ds-bg{position:absolute;inset:0;width:100%;height:100%;z-index:0;pointer-events:none;opacity:.9}
    .ds-hero-copy{position:relative;z-index:1;text-shadow:0 2px 16px rgba(0,0,0,.35)}
    .ds-hero-copy h1{font-size:2.2rem;margin-bottom:8px}.ds-hero-copy p{font-size:1.1rem;opacity:.95}
    @media(min-width:768px){.ds-hero{padding:72px 24px}.ds-hero-copy h1{font-size:2.6rem}.ds-hero-copy p{font-size:1.2rem}}
    @media(prefers-reduced-motion:reduce){.ds-hero{animation:none}}

    .intro-note{text-align:center;background:#eaf4ff;color:#031B4E;padding:12px;font-size:1rem;margin:10px auto;max-width:900px;border-radius:5px;box-shadow:0 2px 5px rgba(0,0,0,.05)}
    section{max-width:1000px;margin:30px auto;padding:20px;background:#fff;border-radius:10px;box-shadow:0 4px 10px rgba(0,0,0,.05)}
    h2{text-align:center;margin-top:40px;color:#031B4E}
    table{width:100%;border-collapse:collapse;margin-top:20px}
    th,td{padding:12px 16px;text-align:left;border-bottom:1px solid #ccc}
    th{background:#031B4E;color:#fff}
    tr:hover{background:#f0f4ff}
    a{color:#0061EB;text-decoration:none}
    footer{background:#E5E8ED;text-align:center;padding:20px;margin-top:40px;font-size:.9rem}

    #avatar-status{position:fixed;bottom:110px;right:20px;background:#fff;border:2px solid #0061EB;border-radius:12px;padding:10px;box-shadow:0 0 10px rgba(0,0,0,.1);display:flex;align-items:center;gap:10px;z-index:999}
    #avatar-status img{width:48px;height:48px}
    #avatar-status span{font-size:.9rem;color:#031B4E;font-weight:bold}

    .responsive-table{overflow-x:auto;-webkit-overflow-scrolling:touch}
    .responsive-table table{width:100%;min-width:600px}

    @media(max-width:768px){
      .intro-note{margin:15px 10px}
      section{width:95%}
      th,td{padding:10px 8px;font-size:.9rem}
      #avatar-status{bottom:90px;right:10px;padding:8px}
      #avatar-status img{width:36px;height:36px}
      #avatar-status span{font-size:.75rem}
    }

    /* ====== CHAT ====== */
    #kc-chat-launcher{
      position:fixed;bottom:50px;right:50px;background:#0061EB;border-radius:50%;width:60px;height:60px;
      color:#fff;border:none;cursor:pointer;font-size:28px;box-shadow:0 2px 6px rgba(0,0,0,.2);z-index:1000
    }
    #kc-chat-window{
      position:fixed;bottom:90px;right:20px;width:320px;height:400px;background:#fff;border:1px solid #ccc;border-radius:10px;
      display:none;flex-direction:column;overflow:hidden;z-index:1001;transition:all 160ms ease;will-change:top,height,transform
    }
    #kc-header{background:#031B4E;color:#fff;padding:10px;display:flex;justify-content:space-between;align-items:center}
    #kc-messages{flex:1;padding:10px;overflow-y:auto;font-size:.9rem;scroll-padding-bottom:84px}
    .kc-badge{display:inline-block;background:#d9e9ff;color:#031B4E;padding:3px 6px;border-radius:6px;font-size:.75rem;margin:2px}
    #kc-badges{padding:4px 8px}
    #kc-role{margin-left:8px}

    /* Sticky input; 16px font to avoid iOS auto-zoom */
    /* Make the whole typing bar a pill */
    #kc-input-box {
      position: sticky; bottom: 0; z-index: 2;
      display: flex; align-items: center; gap: 8px;
    
      /* pill look */
      margin: 8px; /* space from chat window edges so curves are visible */
      padding: 8px;
      background: #f3f6fb;
      border: 1px solid #dbe2ea;
      border-radius: 9999px;
    
      /* mobile safe-area */
      margin-bottom: max(8px, env(safe-area-inset-bottom));
    }
    
    /* Input becomes transparent inside the pill */
    #kc-input {
      flex: 1;
      border: none;
      background: transparent;
      padding: 10px 12px;
      font-size: 16px; /* avoids iOS zoom */
      line-height: 1.4;
      outline: none;
    }
    
    /* Round send button too (mini pill / circle) */
    #kc-send {
      background: #0061EB;
      border: none;
      color: #fff;
      padding: 10px 14px;       /* keep "Send" text comfy; use width/height 40px for an icon */
      border-radius: 9999px;    /* fully rounded button */
      cursor: pointer;
      line-height: 1;
    }

    /* Overlay (also blocks any background gestures) */
    #kc-overlay{position:fixed;inset:0;background:rgba(0,0,0,.4);z-index:1000;display:none;touch-action:none}

    /* Centered modal (desktop) */
    #kc-chat-window.kc-modal{
      top:50%;left:50%;right:auto;bottom:auto;transform:translate(-50%, -50%);
      width:50vw;height:75vh;border-radius:12px;box-shadow:0 12px 28px rgba(0,0,0,.25);display:flex;flex-direction:column;
      transition:top 160ms ease, height 160ms ease
    }

    /* ======= MOBILE baseline: 15% top, 70% height ======= */
    @media (max-width: 768px){
      #kc-chat-window.kc-modal{
        left:50%;transform:translateX(-50%);right:auto;bottom:auto;
        top:15dvh;height:70dvh;width:94vw;border-radius:12px
      }
      @supports not (height:70dvh){#kc-chat-window.kc-modal{top:15svh;height:70svh}}
      @supports not (height:70svh){#kc-chat-window.kc-modal{top:15vh;height:70vh}}
    }

    /* Messages + avatar */
    .kc-msg{display:flex;gap:8px;align-items:flex-start;margin-bottom:8px}
    .kc-bubble{display:inline-block;padding:8px 12px;border-radius:10px;max-width:80%}
    .kc-msg.user{justify-content:flex-end}
    .kc-msg.user .kc-bubble{order:2;background:#0061EB;color:#fff}
    .kc-msg.bot .kc-bubble{background:#E5E8ED;color:#000}
    .kc-msg.user .kc-avatar{display:none}
    .kc-avatar{width:28px;height:28px;flex:0 0 28px;border-radius:50%;background:#031B4E;display:flex;align-items:center;justify-content:center;margin-top:2px;box-shadow:0 1px 2px rgba(0,0,0,.1)}
    .kc-avatar svg{width:18px;height:18px;color:#fff}
    .kc-msg.bot .kc-bubble{max-width:calc(100% - 40px)}
    .kc-typing-row .kc-bubble{background:#E5E8ED;color:#000}
    .kc-typing-dots{display:inline-block;width:1.5em;text-align:left}
    .kc-typing-dots span{display:inline-block;width:.3em;height:.3em;margin-left:.15em;border-radius:50%;background:#8aa0c8;opacity:.2;animation:kc-blink 1.2s infinite}
    .kc-typing-dots span:nth-child(2){animation-delay:.2s}
    .kc-typing-dots span:nth-child(3){animation-delay:.4s}
    @keyframes kc-blink{0%,80%,100%{opacity:.2;transform:translateY(0)}40%{opacity:1;transform:translateY(-1px)}}
    .kc-bubble h1,.kc-bubble h2,.kc-bubble h3{margin:.4em 0 .2em}
    .kc-bubble p{margin:.4em 0}
    .kc-bubble ul,.kc-bubble ol{margin:.4em 0 .4em 1.2em}
    .kc-bubble pre{overflow:auto;padding:8px;border-radius:6px}
  </style>

  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.1.6/dist/purify.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/styles/github.min.css">
  <script src="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/lib/common.min.js"></script>
</head>
<body>
  <!-- HEADER with animated canvas -->
  <header class="ds-hero">
    <canvas id="ds-bg" aria-hidden="true"></canvas>
    <div class="ds-hero-copy">
      <h1>Kevin ‚Äì Senior Data Scientist</h1>
      <p>Explore my experience, projects, and skills</p>
    </div>
  </header>

  <div class="intro-note">
    üí¨ My AI chatbot is available on the <strong>bottom-right corner</strong> ‚Äî feel free to ask about my resume or portfolio.
  </div>

  <section>
    <h2>üìÅ Project Portfolio</h2>
    <div class="responsive-table">
      <table>
        <tr>
          <th>No</th><th>Project</th><th>Description</th><th>Skills</th><th>Link</th>
        </tr>
        <tr>
          <td>1</td>
          <td>SGH AI Antibiotic Prescription Prediction</td>
          <td>The system determines if antibiotics are needed (bacterial infections only) and recommends the specific antibiotic and dose based on patient clinical data. Led a 2-person team to successful delivery.</td>
          <td>PyTorch, MLFlow, Streamlit, Python</td>
          <td><a href="https://www.channelnewsasia.com/singapore/ai-antibiotic-resistance-prescription-sgh-hospital-pneumonia-4759296" target="_blank" rel="noopener">View Project</a></td>
        </tr>
        <tr>
          <td>2</td>
          <td>Career Navigator (Graph Recommender)</td>
          <td>Recommends skills/courses for career advancement and uses GenAI to generate resumes. Served as Data Scientist and Data Engineer Lead on a 10‚Äì15 member team.</td>
          <td>Neo4j, Apache Lucene, GenAI, Java, AngularJS, Apache NiFi, Content-based filtering</td>
          <td><a href="https://neo4j.com/blog/dxc-data-driven-employee-career-development/" target="_blank" rel="noopener">View Project</a></td>
        </tr>
        <tr>
          <td>3</td>
          <td>IT Incident Management Dashboard</td>
          <td>Built real-time dashboard for EG and ServiceNow tickets using Oracle Analytic Server to visualize insights and automate alerts.</td>
          <td>SQL, Oracle Analytic Server, Python, ETL, SSO Integration</td>
          <td></td>
        </tr>
        <tr>
          <td>4</td>
          <td>Digital Twin Traffic Simulation</td>
          <td>Developed traffic simulation platform for layout optimization and flow planning, supporting different scenario modeling.</td>
          <td>SUMO, Python, SQL Server, Django, PDF Reporting</td>
          <td><a href="https://dxc.com/us/en/insights/perspectives/paper/how-advanced-technology-can-empower-smart-border-checkpoints" target="_blank" rel="noopener">View Project</a></td>
        </tr>
        <tr>
          <td>5</td>
          <td>Solution Architect Assistant (Hackathon Runner-Up)</td>
          <td>AI solution for tender response automation (RFP analysis, cost estimation, risk prediction, proposal generation). Runner-up in DXC Global Innovation Hackathon FY‚Äô25.</td>
          <td>Azure GenAI, Vector DB, ReactJS</td>
          <td><a href="https://www.linkedin.com/in/kevin-chng-73485387/details/projects/37813555/multiple-media-viewer/?profileId=ACoAABJ0_VgBhyqEw6PnVSI55CKTson3e7-Ao0E&treasuryMediaId=1737352405914&type=IMAGE" target="_blank" rel="noopener">View Project</a></td>
        </tr>
        <tr>
          <td>6</td>
          <td>OCBC BA Teller System Upgrade</td>
          <td>Upgraded OS on teller systems across 30+ branches (SG & MY), automated deployment via shell scripting, with full stakeholder testing and UAT/SIT coordination.</td>
          <td>Shell Scripting</td>
          <td></td>
        </tr>
        <tr>
          <td>7</td>
          <td>Big Data Automation Data Pipeline</td>
          <td>Designed and built automated big data pipeline using Airflow and Podman, deployed on Red Hat OpenShift. Data sourced from central hub via Oracle GoldenGate replication.</td>
          <td>Python, Apache Airflow, Podman, Red Hat OpenShift, Oracle SQL</td>
          <td></td>
        </tr>
        <tr>
          <td>8</td>
          <td>Personal Projects</td>
          <td>Example: Gait Recognition, Intelligent Reservation System, Image-Based Traffic Density Real-Time Prediction Using SG LTA Traffic Camera, Stock Financial Bot</td>
          <td>Python, OpenCV, Django, TensorFlow, PyTorch, Pandas, ONNX, Intel OpenVINO</td>
          <td><a href="https://www.linkedin.com/in/kevin-chng-73485387/details/projects/?profileId=ACoAABJ0_VgBhyqEw6PnVSI55CKTson3e7-Ao0E" target="_blank" rel="noopener">Project List</a></td>
        </tr>
      </table>
    </div>
  </section>

  <section>
    <h2>üß† Key Skills</h2>
    <div class="responsive-table">
      <table>
        <tr><th>Category</th><th>Skills</th></tr>
        <tr><td>Machine Learning & AI</td><td>scikit-learn, XGBoost, LightGBM, NLP, GenAI, TensorFlow</td></tr>
        <tr><td>MLOps & Deployment</td><td>MLflow, Docker, Airflow, CI/CD, monitoring, model governance</td></tr>
        <tr><td>Big Data & Engineering</td><td>Spark, Kafka, NiFi, SQL, Pandas, PySpark</td></tr>
        <tr><td>Cloud Platforms</td><td>AWS (SageMaker, EC2), Azure, Red Hat OpenShift</td></tr>
      </table>
    </div>
  </section>

  <section>
    <h2>Community Profile</h2>
    <div class="responsive-table">
      <table>
        <tr><th>Platform</th><th>Profile</th></tr>
        <tr><td>GitHub</td><td><a href="https://github.com/KevinChngJY" target="_blank" rel="noopener">github.com/KevinChngJY</a></td></tr>
        <tr><td>LinkedIn</td><td><a href="https://www.linkedin.com/in/kevinchngjy" target="_blank" rel="noopener">linkedin.com/in/kevinchngjy</a></td></tr>
        <tr><td>Medium</td><td><a href="https://medium.com/@kevinchngjy" target="_blank" rel="noopener">medium.com/@kevinchngjy</a></td></tr>
        <tr><td>MATLAB COMMUNITY</td><td><a href="https://www.mathworks.com/matlabcentral/profile/authors/kevinchngjy" target="_blank" rel="noopener">mathworks.com/matlabcentral/profile/authors/kevinchngjy</a></td></tr>
      </table>
    </div>
  </section>

  <!-- Avatar status -->
  <div id="avatar-status">
    <img id="avatar-img" src="https://media.giphy.com/media/xTk9ZvMnbIiIew7IpW/giphy.gif" alt="Loading assistant..." />
    <span id="avatar-text">Loading assistant...</span>
  </div>

  <!-- Chat Launcher -->
  <button id="kc-chat-launcher" aria-label="Open chat">üí¨</button>

  <!-- Modal overlay -->
  <div id="kc-overlay"></div>

  <!-- Chat Window -->
  <div id="kc-chat-window" role="dialog" aria-label="Virtual Kevin chat" aria-modal="true">
    <div id="kc-header">
      <span>Virtual Kevin</span>
      <div>
        <button id="kc-new" style="background:none;border:1px solid #fff;color:white;padding:2px 8px;border-radius:6px;cursor:pointer;margin-right:8px;">New</button>
        <button id="kc-close" style="background:none;border:none;color:white;font-size:18px;cursor:pointer;" aria-label="Close">‚úñ</button>
      </div>
    </div>
    <div id="kc-badges"></div>
    <div id="kc-role" class="kc-badge" style="display:none;"></div>
    <div id="kc-messages" aria-live="polite"></div>
    <div id="kc-session" style="font-size:10px;color:#666;text-align:right;padding:4px 8px;">sid: ‚Ä¶</div>
    <div id="kc-input-box">
      <input id="kc-input" type="text" placeholder="Type your message..." />
      <button id="kc-send">Send</button>
    </div>
  </div>

  <script>
    // --- Config ---
    const PROD = true;
    const API_BASE = PROD ? "https://stingray-app-9hiam.ondigitalocean.app" : "http://localhost:8080";
    const SESSION_KEY = "kc_chat_anon_id";

    // --- Session management ---
    function getSessionId() {
      let id = localStorage.getItem(SESSION_KEY);
      if (!id) {
        id = (crypto.randomUUID && crypto.randomUUID()) || Math.random().toString(36).slice(2);
        localStorage.setItem(SESSION_KEY, id);
      }
      return id;
    }
    function resetSessionId() {
      const old = localStorage.getItem(SESSION_KEY);
      localStorage.removeItem(SESSION_KEY);
      const fresh = getSessionId();
      return { old, fresh };
    }

    // --- DOM refs ---
    const launcher = document.getElementById('kc-chat-launcher');
    const win = document.getElementById('kc-chat-window');
    const overlay = document.getElementById('kc-overlay');
    const closeBtn = document.getElementById('kc-close');
    const newBtn = document.getElementById('kc-new');
    const msgs = document.getElementById('kc-messages');
    const input = document.getElementById('kc-input');
    const sendBtn = document.getElementById('kc-send');
    const badges = document.getElementById('kc-badges');
    const avatarBox = document.getElementById('avatar-status');
    const sessionBadge = document.getElementById('kc-session');
    const roleBadge = document.getElementById('kc-role');

    // Bot icon (inline SVG)
    const BOT_ICON = `
    <svg viewBox="0 0 24 24" fill="none"
        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
        aria-hidden="true" focusable="false">
      <rect x="3" y="4" width="18" height="12" rx="2"></rect>
      <circle cx="12" cy="10" r="2"></circle>
      <path d="M8 14c1.5-2 6.5-2 8 0"></path>
      <path d="M6 20h12"></path>
    </svg>`;

    // Show current session id
    function updateSessionBadge() {
      if (sessionBadge) sessionBadge.textContent = `sid: ${getSessionId()}`;
    }
    updateSessionBadge();

    // Avatar status tweak
    setTimeout(() => {
      document.getElementById('avatar-img').src = 'https://media.giphy.com/media/10dU7AN7xsi1I4/giphy.gif';
      document.getElementById('avatar-text').textContent = "Kevin's assistant is online!";
    }, 3000);
    function setAvatarVisible(on) {
      if (!avatarBox) return;
      avatarBox.style.display = on ? 'flex' : 'none';
    }

    // --- Message helpers ---
    function addMsg(role, text) {
      const row = document.createElement('div');
      row.className = `kc-msg ${role}`;

      if (role === 'bot') {
        const avatar = document.createElement('div');
        avatar.className = 'kc-avatar';
        avatar.innerHTML = BOT_ICON;
        avatar.title = 'Virtual Kevin';
        row.appendChild(avatar);
      }

      const bubble = document.createElement('div');
      bubble.className = 'kc-bubble';

      if (role === 'bot') {
        const html = DOMPurify.sanitize(marked.parse(text || ''));
        bubble.innerHTML = html;
      } else {
        bubble.textContent = text;
      }

      row.appendChild(bubble);
      msgs.appendChild(row);
      msgs.scrollTop = msgs.scrollHeight;

      if (role === 'bot' && window.hljs) {
        row.querySelectorAll('pre code').forEach(block => hljs.highlightElement(block));
      }
    }
    const addUser = (t) => addMsg('user', t);
    const addBot  = (t) => addMsg('bot', t);

    function hasAnyMessage() { return !!msgs.querySelector('.kc-msg'); }
    function ensureGreeting() {
      if (!hasAnyMessage()) addBot("Hello! I‚Äôm **Virtual Kevin**. Ask me about my portfolio, background, or projects.");
    }

    function showRole(role) {
      if (!roleBadge) return;
      if (!role) { roleBadge.style.display = 'none'; roleBadge.textContent = ''; return; }
      const label = role === 'recruiter_interviewer' ? 'Recruiter/Interviewer' : 'General';
      roleBadge.textContent = `Role: ${label}`;
      roleBadge.style.display = 'inline-block';
    }
    function clearRole() { if (!roleBadge) return; roleBadge.style.display = 'none'; roleBadge.textContent = ''; }
    function showCompanies(companies) {
      badges.innerHTML = '';
      if (!companies || !companies.length) return;
      companies.slice(0, 3).forEach(c => {
        const tag = document.createElement('span');
        tag.className = 'kc-badge';
        tag.textContent = c.name;
        badges.appendChild(tag);
      });
    }

    function scrollMessagesToBottom(){ msgs.scrollTop = msgs.scrollHeight; }

    // --- Freeze background (no page movement) ---
    let pageScrollY = 0;
    function freezePage() {
      pageScrollY = window.scrollY || 0;
      document.documentElement.classList.add('kc-freeze');
      document.body.classList.add('kc-freeze');
      document.body.style.top = `-${pageScrollY}px`;
      // Scrollbar compensation on desktop only:
      const sbw = window.innerWidth - document.documentElement.clientWidth;
      if (sbw > 0) document.body.style.paddingRight = sbw + 'px';
    }
    function unfreezePage() {
      document.documentElement.classList.remove('kc-freeze');
      document.body.classList.remove('kc-freeze');
      document.body.style.top = ''; document.body.style.paddingRight = '';
      window.scrollTo(0, pageScrollY);
    }

    // --- Modal helpers ---
    let baseline = null; // { topPx, heightPx }
    function captureBaseline(force=false){
      if (baseline && !force) return;
      const cs = getComputedStyle(win);
      baseline = { topPx: parseFloat(cs.top)||0, heightPx: parseFloat(cs.height)||0 };
    }
    function restoreToBaseline(){
      if (!baseline){ resetInlineModalStyles(); return; }
      win.style.top = baseline.topPx + 'px';
      win.style.height = baseline.heightPx + 'px';
      win.style.left = '50%';
      win.style.transform = 'translateX(-50%)';
      win.style.right = 'auto';
      win.style.bottom = 'auto';
      scrollMessagesToBottom();
    }
    function resetInlineModalStyles(){
      win.style.removeProperty('top');
      win.style.removeProperty('height');
      win.style.removeProperty('left');
      win.style.removeProperty('transform');
      win.style.removeProperty('right');
      win.style.removeProperty('bottom');
    }

    function isSmallScreen(){ return window.matchMedia('(max-width: 768px)').matches; }
    function isKeyboardOpen(){
      if (!window.visualViewport) return false;
      const ratio = window.visualViewport.height / window.innerHeight;
      return ratio < 0.92;
    }
    function applyKeyboardLayout(){
      if (!isSmallScreen() || !win.classList.contains('kc-modal') || !window.visualViewport) return;
      const vv = window.visualViewport;
      const topPx    = vv.height * 0.15 + vv.offsetTop;
      const heightPx = vv.height * 0.70;

      win.style.top = topPx + 'px';
      win.style.height = heightPx + 'px';
      win.style.left = '50%';
      win.style.transform = 'translateX(-50%)';
      win.style.right = 'auto';
      win.style.bottom = 'auto';
      scrollMessagesToBottom();
    }
    function fitMobileModal(){
      if (!isSmallScreen() || !win.classList.contains('kc-modal')) return;
      if (isKeyboardOpen()) applyKeyboardLayout(); else restoreToBaseline();
    }

    // Track keyboard state to guard overlay clicks
    let kbOpen = false;
    function setKbOpenState(nowOpen){
      if (kbOpen === nowOpen) return;
      kbOpen = nowOpen;
      if (!kbOpen){
        overlay.dataset.justClosedKeyboard = '1';
        restoreToBaseline();
        setTimeout(()=>{ delete overlay.dataset.justClosedKeyboard; }, 350);
      }
    }

    function enterModal() {
      win.style.display = 'flex';
      launcher.style.display = 'none';
      win.classList.add('kc-modal');
      overlay.style.display = 'block';
      freezePage();
      requestAnimationFrame(()=>{
        if (!isKeyboardOpen()) captureBaseline(true);
        fitMobileModal();
      });
    }
    function exitModal() {
      win.classList.remove('kc-modal');
      overlay.style.display = 'none';
      unfreezePage();
    }

    // Open chat
    launcher.addEventListener('click', () => {
      ensureGreeting();
      enterModal();
      setAvatarVisible(false);
    });

    function closeChat() {
      win.style.display = 'none';
      launcher.style.display = 'inline-block';
      exitModal();
      setAvatarVisible(true);
    }
    closeBtn.addEventListener('click', closeChat);

    overlay.addEventListener('click', (e) => {
      if (isSmallScreen() && (kbOpen || overlay.dataset.justClosedKeyboard === '1')) {
        e.preventDefault(); e.stopPropagation();
        restoreToBaseline(); return;
      }
      closeChat();
    });

    window.addEventListener('keydown', (e) => { if (e.key === 'Escape' && win.style.display !== 'none') closeChat(); });

    // New chat
    newBtn.addEventListener('click', async () => {
      resetSessionId();
      updateSessionBadge();
      msgs.innerHTML = "";
      badges.innerHTML = "";
      clearRole();
      ensureGreeting();
      enterModal();
    });

    // Clicking message keeps centered
    document.getElementById('kc-messages').addEventListener('click', (e) => {
      if (e.target.closest('.kc-bubble')) enterModal();
    });

    // IMPORTANT: Do NOT scroll the page on focus
    input.addEventListener('focus', () => {
      enterModal();                 // ensures frozen state before keyboard
      scrollMessagesToBottom();     // only scroll the messages pane
      if (window.visualViewport) applyKeyboardLayout();
      // Keep the layout viewport anchored (no page jump)
      window.scrollTo(0, pageScrollY);
    });

    // Typing indicator
    let typingRow = null;
    function showTyping() {
      if (typingRow) return;
      typingRow = document.createElement('div');
      typingRow.className = 'kc-msg bot kc-typing-row';
      const avatar = document.createElement('div'); avatar.className = 'kc-avatar'; avatar.innerHTML = BOT_ICON; avatar.title = 'Virtual Kevin';
      const bubble = document.createElement('div'); bubble.className = 'kc-bubble';
      bubble.innerHTML = `Kevin is typing <span class="kc-typing-dots"><span></span><span></span><span></span></span>`;
      typingRow.appendChild(avatar); typingRow.appendChild(bubble);
      msgs.appendChild(typingRow);
      scrollMessagesToBottom();
    }
    function hideTyping(){ if(!typingRow) return; try{ msgs.removeChild(typingRow) }catch{} typingRow=null; }

    // Send message
    async function sendMessage() {
      const text = input.value.trim();
      if (!text) return;
      input.value = '';
      addUser(text);
      showTyping();
      sendBtn.disabled = true;

      try {
        const payload = { session_id: getSessionId(), message: text, utm_source: "web" };
        const res = await fetch(`${API_BASE}/chat`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        const ctype = (res.headers.get('content-type') || '').toLowerCase();
        hideTyping();
        sendBtn.disabled = false;

        if (ctype.includes('text/markdown')) {
          const md = await res.text();
          addBot(md);
          return;
        }

        const data = await res.json();
        showRole(data.role);
        showCompanies(data.companies);

        if (data.answer) addBot(data.answer);
        else if (data.error) addBot(`**Error:** ${data.error}`);
        else addBot("_No response from server._");
      } catch (err) {
        hideTyping();
        sendBtn.disabled = false;
        addBot("**Network error.** Please try again.");
      }
    }

    sendBtn.addEventListener('click', sendMessage);
    input.addEventListener('keydown', (e) => { if (e.key === 'Enter') sendMessage(); });

    // ====== HEADER data-network animation (unchanged) ======
    (() => {
      const canvas = document.getElementById('ds-bg');
      if (!canvas) return;
      const ctx = canvas.getContext('2d');
      const BG_LINE = 'rgba(255,255,255,0.18)';
      const BG_NODE = 'rgba(255,255,255,0.85)';
      const ACCENT  = 'rgba(0,145,255,0.45)';
      const reduceMotion = window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches;

      let w = 0, h = 0, dpr = Math.min(window.devicePixelRatio || 1, 2);
      function resize() {
        const rect = canvas.getBoundingClientRect();
        w = Math.max(1, Math.floor(rect.width));
        h = Math.max(1, Math.floor(rect.height));
        dpr = Math.min(window.devicePixelRatio || 1, 2);
        canvas.width = Math.floor(w * dpr);
        canvas.height = Math.floor(h * dpr);
        ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
      }
      resize();
      window.addEventListener('resize', resize);

      const nodes = [];
      const mouse = { x: null, y: null, active: false };
      const MAX_COUNT = () => Math.max(18, Math.min(Math.round((w*h)/18000), 80));
      function spawnNodes(n) {
        for (let i = 0; i < n; i++) {
          nodes.push({
            x: Math.random() * w,
            y: Math.random() * h,
            vx: (Math.random() - 0.5) * 0.5,
            vy: (Math.random() - 0.5) * 0.5,
            r: 1.2 + Math.random() * 1.8
          });
        }
      }
      spawnNodes(MAX_COUNT());

      canvas.addEventListener('mousemove', (e) => {
        const rect = canvas.getBoundingClientRect();
        mouse.x = (e.clientX - rect.left);
        mouse.y = (e.clientY - rect.top);
        mouse.active = true;
      });
      canvas.addEventListener('mouseleave', () => { mouse.active = false; });

      function connectThreshold() { return Math.max(48, Math.min(140, Math.sqrt(w*h) / 14)); }
      const FRICTION = 0.998;

      let rafId = null;
      function drawFrame() {
        const want = MAX_COUNT();
        if (want > nodes.length) spawnNodes(want - nodes.length);
        if (want < nodes.length) nodes.splice(want, nodes.length - want);

        ctx.clearRect(0, 0, w, h);

        for (let i = 0; i < nodes.length; i++) {
          const n = nodes[i];
          if (mouse.active) {
            const dx = n.x - mouse.x, dy = n.y - mouse.y;
            const dist2 = dx*dx + dy*dy, rad = 80;
            if (dist2 < rad*rad) {
              const dist = Math.sqrt(dist2) || 0.001;
              const force = (rad - dist) / rad * 0.015;
              n.vx += (dx / dist) * force;
              n.vy += (dy / dist) * force;
            }
          }
          n.x += n.vx; n.y += n.vy;
          n.vx *= FRICTION; n.vy *= FRICTION;
          if (n.x < 0 || n.x > w) n.vx *= -1, n.x = Math.max(0, Math.min(w, n.x));
          if (n.y < 0 || n.y > h) n.vy *= -1, n.y = Math.max(0, Math.min(h, n.y));
        }

        const thresh = connectThreshold();
        for (let i = 0; i < nodes.length; i++) {
          for (let j = i + 1; j < nodes.length; j++) {
            const a = nodes[i], b = nodes[j];
            const dx = a.x - b.x, dy = a.y - b.y;
            const d2 = dx*dx + dy*dy;
            if (d2 > thresh*thresh) continue;
            const d = Math.sqrt(d2) || 1;
            const t = 1 - (d / thresh);
            ctx.strokeStyle = t > 0.75 ? ACCENT : BG_LINE;
            ctx.lineWidth = 1 * (0.4 + 0.6 * t);
            ctx.beginPath();
            ctx.moveTo(a.x, a.y);
            ctx.lineTo(b.x, b.y);
            ctx.stroke();
          }
        }

        for (let i = 0; i < nodes.length; i++) {
          const n = nodes[i];
          ctx.fillStyle = BG_NODE;
          ctx.beginPath();
          ctx.arc(n.x, n.y, n.r, 0, Math.PI * 2);
          ctx.fill();
        }
      }

      function tick() {
        if (reduceMotion) { drawFrame(); return; }
        drawFrame();
        rafId = requestAnimationFrame(tick);
      }
      tick();
      window.addEventListener('beforeunload', () => { if (rafId) cancelAnimationFrame(rafId); });
    })();

    // ====== VisualViewport wiring (keep page anchored while frozen) ======
    let vvDebounce;
    function onVV(){
      if (!isSmallScreen() || !win.classList.contains('kc-modal')) return;
      clearTimeout(vvDebounce);
      vvDebounce = setTimeout(() => {
        const now = isKeyboardOpen();
        setKbOpenState(now);
        if (document.body.classList.contains('kc-freeze')) {
          // Re-anchor the layout viewport to the original scroll position.
          window.scrollTo(0, pageScrollY);
        }
        if (now) applyKeyboardLayout(); else restoreToBaseline();
      }, 50);
    }
    if (window.visualViewport) {
      window.visualViewport.addEventListener('resize', onVV);
      window.visualViewport.addEventListener('scroll', onVV);
    }
    window.addEventListener('orientationchange', () => setTimeout(() => { restoreToBaseline(); }, 250));
    window.addEventListener('resize', () => { if (!isKeyboardOpen()) restoreToBaseline(); });

    // When closing from anywhere, restore baseline & background
    const _origCloseChat = closeChat;
    window.closeChat = function() { restoreToBaseline(); _origCloseChat(); };

    input.addEventListener('blur', () => setTimeout(() => {
      if (!isKeyboardOpen()) restoreToBaseline();
    }, 80));
  </script>
</body>
</html>



